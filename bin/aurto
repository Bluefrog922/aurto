#!/usr/bin/env bash

set -eu
version="0.5"
command=${1:-}
arg1=${2:-}

bin_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
lib_dir="$bin_dir/../lib/aurto"
# shellcheck source=../lib/aurto/shared-functions disable=SC1091
source "$lib_dir/shared-functions"

if [ "$command" == "add" ] && [ -n "$arg1" ]; then
  sudo pacsync aurto >/dev/null
  echo "aurto: Running: \`aursync --no-view --rmdeps --no-confirm --chroot --repo=aurto ${*:2}\`" >&2
  "$lib_dir"/summerize-build aursync --no-view --rmdeps --no-confirm --chroot --repo=aurto "${@:2}"
  sudo pacsync aurto >/dev/null
elif [ "$command" == "addpkg" ] && [ -n "$arg1" ]; then
  echo "aurto: Running: \`repo-add /var/cache/pacman/aurto/aurto.db.tar ${*:2}\`" >&2
  repo-add /var/cache/pacman/aurto/aurto.db.tar "${@:2}"
  for pkg in "${@:2}"; do
    cp "$pkg" /var/cache/pacman/aurto/
  done
  sudo pacsync aurto >/dev/null
elif [ "$command" == "remove" ] && [ -n "$arg1" ]; then
  removed=""
  for pkg in "${@:2}"; do
    remove_out=$(repo-remove /var/cache/pacman/aurto/aurto.db.tar "$pkg" 2>&1)
    if [[ $remove_out = *"ERROR"* ]]; then
      echo "aurto: $(cyan "$pkg") $(red not found)" >&2
    else
      rm -rf /var/cache/pacman/aurto/"$pkg"*.pkg.* || true
      removed="$pkg $removed"
    fi
  done
  if [ -n "$removed" ]; then
    echo -e "aurto: Removed $(cyan "$removed")" >&2
    sudo pacsync aurto >/dev/null
  fi
else
  echo "$(bold aurto) v$version: simple management tool for the 'aurto' repository"
  echo "  Usage: $(green aurto add)|$(green addpkg)|$(green remove) $(cyan PACKAGES...)"
  echo
  echo "  Examples"
  echo "  - add: build, or rebuild if newer than existing, one or more aur packages & add to the 'aurto' repo"
  echo "      $(green aurto add) $(cyan aurutils)"
  echo
  echo "  - remove: remove a package from the 'aurto' repo (does not uninstall)"
  echo "      $(green aurto remove) $(cyan aurutils)"
  echo
  echo "  - addpkg: add a prebuilt package to the 'aurto' repo"
  echo "      $(green aurto addpkg) $(cyan aurutils-1.5.3-8-any.pkg.tar.xz)"
  exit 1
fi
